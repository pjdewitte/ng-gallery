/**
 * Created by leefsmp on 4/16/15.
 */
var del = require("del");
var vinylPaths = require('vinyl-paths');

//Gulp modules
var gulp = require("gulp");
var gutil = require('gulp-util');
var bower = require('gulp-bower');
var jshint = require('gulp-jshint');
var uglify = require('gulp-uglify');
var webpack = require("webpack-stream");
var ngAnnotate = require('gulp-ng-annotate');

var config = {
  buildDir: './www/build',
  bowerDir: './www/lib/bower_components'
};

///////////////////////////////////////////////////////////////////////////
// Clean Task
//
///////////////////////////////////////////////////////////////////////////
gulp.task('clean', function () {

  return gulp.src(config.buildDir + '/*.js', {read: false})
    .pipe(vinylPaths(del));
});

///////////////////////////////////////////////////////////////////////////
// bower task
//
///////////////////////////////////////////////////////////////////////////
gulp.task('bower', function() {
  return bower({directory: config.bowerDir}).pipe(
    gulp.dest(config.bowerDir));
});

///////////////////////////////////////////////////////////////////////////
// lint task checks any JavaScript file
// and makes sure there are no errors
//
///////////////////////////////////////////////////////////////////////////
gulp.task('lint', function() {
  return gulp.src('www/js/**/*.js')
    .pipe(jshint())
    .pipe(jshint.reporter('default'));
});

///////////////////////////////////////////////////////////////////////////
// PostCss task
// and makes sure there are no errors
//
///////////////////////////////////////////////////////////////////////////
gulp.task('postcss', function () {
  var postcss = require('gulp-postcss');
  return gulp.src('src/**/*.css')
    .pipe( postcss([ require('autoprefixer'), require('cssnano') ]) )
    .pipe( gulp.dest('build/') );
});

///////////////////////////////////////////////////////////////////////////
// Webpack build-debug task
//
///////////////////////////////////////////////////////////////////////////
gulp.task("webpack:build-debug", ['clean', 'bower'], function(callback) {

  var webpackConfig = require("./config/webpack.config.js");

  return gulp.src('www/js/app.js')
    .pipe(webpack(webpackConfig))
    .pipe(gulp.dest(config.buildDir));
});

///////////////////////////////////////////////////////////////////////////
// Webpack build-debug task
//
///////////////////////////////////////////////////////////////////////////
gulp.task("webpack:build-prod", ['clean', 'bower'], function(callback) {

  var webpackConfig = require("./config/webpack.config.js");

  return gulp.src('www/js/app.js')
    .pipe(webpack(webpackConfig))
    .pipe(gulp.dest(config.buildDir));
});

///////////////////////////////////////////////////////////////////////////
// Compress task: uglyfy and minify js
//
///////////////////////////////////////////////////////////////////////////
gulp.task('compress', ['webpack:build-prod'], function() {

  return gulp.src(config.buildDir + '/*.js')
    .pipe(ngAnnotate())
    .pipe(uglify({mangle: false})).on('error', gutil.log)
    .pipe(gulp.dest(config.buildDir));
});

///////////////////////////////////////////////////////////////////////////
// Debug build
//
///////////////////////////////////////////////////////////////////////////
gulp.task('build-debug', ['webpack:build-debug']);

///////////////////////////////////////////////////////////////////////////
// Production build
//
///////////////////////////////////////////////////////////////////////////
gulp.task('build-prod', ['compress']);

///////////////////////////////////////////////////////////////////////////
// Default task
//
///////////////////////////////////////////////////////////////////////////
gulp.task('default', ['build-prod']);
